@{
    ViewData["Title"] = "草稿編輯";
}
@model List<article>
@{
    //List<ArticleTagList> articleTagList = ViewBag.articleTagList;
    //articleTagList = articleTagList.OrderBy(a => a.TagClass).ToList();
    var currentId = ViewBag.articleId;
    article target;
    string time;
    if (currentId == null)
    {
        target = Model.LastOrDefault()!;
    }
    else
    {
        target = Model.FirstOrDefault(a => a.ArticleId == currentId)!;
    }
    if (target == null)
    {
        target = new article()
                {
                    ArticleId = 0,
                    TravelTime = DateTime.Now,
                };
    }
    var tempTime = (DateTime)target!.TravelTime!;
    time = tempTime.ToString("yyyy-MM-ddTHH:mm");
    string content = target!.Contents!;
}
<style>
    :root {
        --primary-color: #1B1924;
        --secondary-color: #B5C1B4;
        --tertiary-color: #DCD9C6;
        --accent-color: #74593D;
        --text-color: #3F3232;
    }

    body {
        background-color: var(--tertiary-color);
        color: var(--text-color);
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
    }

    #notification {
        display: none;
        position: fixed;
        top: 10px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--secondary-color);
        color: var(--text-color);
        padding: 10px 20px;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
    }

    .selectedTag {
        background-color: var(--accent-color);
        color: #fff;
        border: 1px solid var(--accent-color);
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .unselectedTag {
        background-color: var(--secondary-color);
        color: var(--text-color);
        border: 1px solid var(--secondary-color);
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }

    .buttons{
        margin:2px;
    }

    .articleLabel{
        color: var(--primary-color);
    }

    .articleInput{
        border-color: var(--primary-color);
    }

    .articleSelect{
/*         background-color: var(--secondary-color); */
        color: var(--text-color); 
        border-color: var(--primary-color);
    }
</style>
<script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4=" crossorigin="anonymous"></script>
@* <script src="~/lib/_js/jquery-3.6.0.js"></script> *@
<script src="https://cdn.tiny.cloud/1/cx5w3vy6l6bg0senjow539pjj585n4wqopo9s4r3viuyx88c/tinymce/6/tinymce.min.js"
        referrerpolicy="origin"></script>
@* <h2>草稿編輯</h2>
<h1> 當前ID:@target.ArticleId</h1> *@
<input type="text" id="articleId" value="@target.ArticleId" style="display:none;">
<div class="container">
    
    <div class="row justify-content-center align-items-center">
        <!-- 创建三个列（columns） -->
        <div class="col-sm-2">
            <img src="@target.Images" id="articleImage" style="width: 150px; height: 150px; cursor: pointer;" />
            <input type="file" id="articleImageUpload" style="display:none;" />
        </div>
        <div class="col-sm-8 text-center">
            <div class="row">
                <div class="col-auto">
                    <label for="title" class="articleLabel">標題:</label>
                </div>
                <div class="col">
                    <!-- 添加 .form-control 类 -->
                    <input type="text" id="title" value="@target.Title" class="form-control articleInput">
                </div>
            </div>
            <div class="row">
                <div class="col-auto">
                    <label for="subtitle" class="articleLabel">副標題:</label>
                </div>
                <div class="col">
                    <!-- 添加 .form-control 类 -->
                    <input type="text" id="subtitle" value="@target.Subtitle" class="form-control articleInput">
                </div>
            </div>
            <div class="row">
                <div class="col-auto">
                    <label for="travelTime" class="articleLabel">時間:</label>
                </div>
                <div class="col">
                    <!-- 添加 .form-control 类 -->
                    <input type="datetime-local" id="travelTime" value="@time" class="form-control articleInput">
                </div>
            </div>
        </div>
        <div class="col-sm-2">
            <select id="dropdown" class="form-select articleSelect">
                @foreach (var article in Model)
                {
                    <option value="@article.ArticleId">@article.Title</option>
                }
            </select>
            <div >
                <button id="saveButton" class="btn btn-dark buttons">儲存</button>
                <button id="createButton" class="btn btn-dark buttons">新增</button>
                <button id="publishButton" class="btn btn-dark buttons">發佈</button>
                <button id="deleteButton" class="btn btn-danger buttons">删除</button>
@*                 <button id="testButton" class="btn btn-danger">測試</button> *@
            </div>

        </div>
    </div>
</div>






@* <div>
    @foreach(ArticleTagList item in articleTagList)
    {
        <span onclick="selectTag(this)" id="tag_@item.LabelId" class="unselectedTag">@item.TagName</span>
    }
</div> *@
<div>
    <textarea id="tiny"></textarea>
</div>


<div id="notification">562323</div>


<script>

    let backendData = @Html.Raw(Json.Serialize(content));
    console.log(backendData);
    $(function () {
        let dropdown = $("#dropdown");
        let articleId = $('#articleId').val();
        const image_upload_handler = (blobInfo, progress) => new Promise((resolve, reject) => {
            const xhr = new XMLHttpRequest();
            xhr.withCredentials = false;
            xhr.open('POST', '/Article/UploadImage');

            xhr.upload.onprogress = (e) => {
                progress(e.loaded / e.total * 100);
            };

            xhr.onload = () => {
                if (xhr.status === 403) {
                    reject({ message: 'HTTP Error: ' + xhr.status, remove: true });
                    return;
                }

                if (xhr.status < 200 || xhr.status >= 300) {
                    reject('HTTP Error: ' + xhr.status);
                    return;
                }

                const json = JSON.parse(xhr.responseText);

                if (!json || typeof json.location != 'string') {
                    reject('Invalid JSON: ' + xhr.responseText);
                    return;
                }

                resolve(json.location);
            };

            xhr.onerror = () => {
                reject('Image upload failed due to a XHR Transport error. Code: ' + xhr.status);
            };

            const formData = new FormData();
            formData.append('file', blobInfo.blob());
            formData.append('articleId', articleId);

            xhr.send(formData);
        });
        tinymce.init({
            selector: '#tiny',
            plugins: 'image',
            toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | image | addcomment showcomments | spellcheckdialog a11ycheck typography | align lineheight ',
            automatic_uploads: true,
            images_upload_handler: image_upload_handler,
            file_picker_types: 'image',
            init_instance_callback: function (editor) {
                if (backendData == null) {
                    editor.setContent("");
                }
                else {
                    editor.setContent(backendData);
                }
            }
        });
        for (let i = 0; i < dropdown.children().length; i++) {
            if (dropdown.children()[i].value == articleId) {
                dropdown.val(dropdown.children()[i].value);
                break;
            }
        }

        $("#dropdown").on("change", function () {
            let id = $(this).val();

            window.location = '/Article/Draft?articleId=' + id;
        });
        

        function save() { 
            var contentImages = [];
            var editorContent = tinymce.get('tiny').getContent();
            editorContent = editorContent.replace(/src="img/g, 'src="/img');
            var tempElement = $('<div>').html(editorContent);
            tempElement.find('img').each(function () {
                var src = $(this).attr('src');
                contentImages.push(src.substring(src.lastIndexOf('/') + 1));
            });
            let articleData = {
                articleId: articleId,
                title: $('#title').val(),
                subtitle: $('#subtitle').val(),
                travelTime: $('#travelTime').val(),
                content: editorContent,
                contentImages: JSON.stringify(contentImages)
            };
            $.ajax({
                type: "POST",
                url: "/Article/Save", // 控制器的 URL
                data: articleData,
                success: function (response) {
                    showNotification("保存成功");
                }
            });
            
        }
        $('#saveButton').on('click', save);

        
        $('#deleteButton').on('click', function () {
            var confirmation = confirm("確定要刪除這篇草稿嗎？");
            if (confirmation) {
                $.post("/Article/Delete", { articleId: articleId })
                    .done(function () {
                        alert("刪除成功");
                        window.location = "/Article/Draft/"
                    })
            }
        });
        $('#createButton').on('click', function () {

            $.ajax({
                type: "post",
                url: "/Article/CreateDraft", // 控制器的 URL
                success: function (response) {
                    alert("新增成功");
                    window.location = "/Article/Draft/"
                }
            });
        });
        $('#publishButton').on('click', function () {
            var confirmation = confirm("確定要發佈嗎？");
            if (confirmation) {
                save();
                $.post("/Article/PublishDraft", { articleId: articleId })
                    .done(function () {
                        window.location = '/Article/ArticleView?articleId=' + articleId;
                    })
            }
        });



        $('#articleImage').on('click', function () {
            $('#articleImageUpload').click();
        });

        $('#articleImageUpload').on('change', function () {
            var file = this.files[0];
            var formData = new FormData();
            formData.append('file', file);
            formData.append('articleId', articleId);
            $.ajax({
                type: "post",
                url: "/Article/UploadArticleImage",
                data: formData,
                processData: false,  // 禁止 jQuery 处理数据
                contentType: false,  // 禁止 jQuery 设置内容类型
                success: function (src) {
                    $('#articleImage').prop('src', src);
                }
            });
        });

        function showNotification(message) {
            $("#notification").text(message).css("display","block")
            setTimeout(function () {
                $("#notification").css("display", "none");
            },1000)
        }
        $('#testButton').on('click', function () {
            let tags = $(".selectedTag")
            let tagList = [];
            tags.each(function (e) { 
                let idString = $(this).prop("id");
                let tagId = idString.substring(idString.lastIndexOf("_") + 1);
                let tagObj = {

                }
                console.log();
            })
            
        });
        // $(window).on('beforeunload', function () {
        //     return '您确定要离开当前页面吗？'; // 在离开页面时弹出提示
        // });

        // // 当用户点击页面上的其他链接或者刷新页面时，解除beforeunload事件绑定
        // $('a').on('click', function () {
        //     $(window).off('beforeunload');
        // });
    });

    function selectTag(tag) {
        console.log(tag.id);
        if (tag.classList.contains("selectedTag")) {
            tag.classList.remove("selectedTag"); // 移除未選中的樣式
            tag.classList.add("unselectedTag"); // 添加選中的樣式
        }
        else {
            tag.classList.remove("unselectedTag"); // 移除未選中的樣式
            tag.classList.add("selectedTag"); // 添加選中的樣式
        }

    }
</script>
